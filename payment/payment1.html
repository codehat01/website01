<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Registration Form</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        :root {
            --primary-color: #b22049;
            --primary-light: #d4436d;
            --primary-dark: #8c1a3a;
            --white: #ffffff;
            --light-gray: #f4f4f4;
            --dark-gray: #333333;
            --transition: all 0.3s ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--dark-gray);
            background-image: url(Welcome.png);
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;

        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            transition: var(--transition);
            position: relative;
        }

        .container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        h1,
        h2 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 1.5rem;
            position: relative;
        }

        h1::after,
        h2::after {
            content: '';
            display: block;
            width: 50px;
            height: 3px;
            background-color: var(--primary-color);
            margin: 0.5rem auto;
        }

        form {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-top: 1rem;
            font-weight: 600;
            color: var(--primary-dark);
        }

        input,
        select {
            margin-bottom: 1rem;
            padding: 0.8rem;
            border: 2px solid var(--light-gray);
            border-radius: 5px;
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(178, 32, 73, 0.2);
        }

        button {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: var(--transition);
            margin-top: 1rem;
        }

        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(178, 32, 73, 0.3);
        }

        .hidden {
            display: none;
        }

        .pay {
            text-align: center;
            margin-top: 2rem;
        }

        #upi-qr {
            width: 200px;
            height: 200px;
            margin: 1rem auto;
            border-radius: 10px;
            transition: var(--transition);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        #upi-qr:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(178, 32, 73, 0.2);
        }

        #paymentAmount {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        #teamMembersContainer {
            border: 2px solid var(--light-gray);
            border-radius: 5px;
            padding: 1rem;
            margin-top: 1rem;
            transition: var(--transition);
        }

        #teamMembersContainer:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(178, 32, 73, 0.2);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #page1,
        #page2,
        #page3 {
            animation: fadeIn 0.5s ease-out;
        }

        .nav-arrow {
            z-index: 1000 !important;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2rem;
            color: var(--primary-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .nav-arrow:hover {
            color: var(--primary-dark);
        }

        .nav-arrow.left {
            left: 1rem;
        }

        .nav-arrow.right {
            right: 1rem;
        }

        @media (max-width: 600px) {
            .container {
                padding: 1rem;
                margin: 1rem;
            }

            input,
            select,
            button {
                font-size: 0.9rem;
            }

            .nav-arrow {
                font-size: 1.5rem;
            }
        }

        .info {
            display: inline;
            margin-left: 15px;
            font-size: 14px;
        }

        .qr-code-section {
            text-align: center;
            max-width: 800px;
            margin: 2rem auto;
            padding: 20px;
            transition: var(--transition);
            position: relative;
        }

        .qr-code-container {
            margin: 2rem auto;
            width: 200px;
            height: 200px;
            position: relative;
        }

        .qr-code {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--white);
            transition: opacity 0.3s ease;
        }

        .qr-code.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .qr-options {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .qr-option {
            background-color: var(--light-gray);
            border: none;
            padding: 0.5rem 1rem;
            margin: 0 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            color: var(--dark-gray);
        }

        .qr-option.active {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .qr-label {
            margin-top: 1rem;
            font-weight: 600;
            color: var(--primary-dark);
        }

        #upi-link {
            display: inline-block;
            margin-top: 1rem;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        #paymentAmount {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--primary-color);
        }



        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        /*team members*/
        .team-members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .team-member-input {
            display: flex;
            flex-direction: column;
        }

        .team-member-input label {
            margin-bottom: 5px;
            font-weight: bold;
        }

        .team-member-input input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .team-members-grid {
                grid-template-columns: 1fr;
            }
        }

        /*paymentbutton*/
        .paycon {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
        }

        .button {
            padding: 15px 30px;
            margin: 10px;
            font-size: 16px;
            color: #fff;
            background-color: #34b7f1;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            width: 200px;
        }

        .button:hover {
            background-color: #28a7e0;
        }

        .paytm {
            background-color: #003399;
        }

        .paytm:hover {
            background-color: #002366;
        }

        .phonepe {
            background-color: #5c2d91;
        }

        .phonepe:hover {
            background-color: #4a2176;
        }

        @media (max-width: 768px) {
            .paycon {
                flex-direction: column;
            }

            .button {
                width: 100%;
                max-width: 300px;
                margin: 10px auto;
            }
        }

        /* Profile Container */
        .profile-container {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .profile-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ddd;
            cursor: pointer;
            overflow: hidden;
        }

        .profile-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Profile Dropdown */
        .profile-dropdown {
            display: none;
            position: absolute;
            top: 60px;
            right: 0;
            background-color: #1f1f1f;
            border-radius: 10px;
            width: 320px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 20px;
            z-index: 1000;
            color: white;
        }

        .profile-dropdown h2,
        .profile-dropdown p {
            margin: 0;
            color: white;
        }

        .profile-dropdown h2 {
            font-size: 18px;
            font-weight: normal;
            margin-bottom: 5px;
        }

        .profile-dropdown p {
            font-size: 14px;
            color: #bbb;
        }

        /* Account Actions */
        .account-actions {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
        }

        .account-actions button {
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px;
            width: 48%;
            cursor: pointer;
            text-align: center;
        }

        .account-actions button:hover {
            background-color: #555;
        }

        /* Close Button */
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

        /* Login Overlay */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-box {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
        }

        .google-sign-in-button {
            background-color: #b22049;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }

        /* Purchase History */
        .purchase-history {
            max-height: 200px;
            overflow: hidden;
        }

        .purchase-list-container {
            max-height: 150px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .purchase-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .purchase-list-container::-webkit-scrollbar {
            width: 8px;
        }

        .purchase-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .purchase-list-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .purchase-list-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        #highlightedMarquee {
            background-color: #b22049;
            font-weight: bold;
            color: white;
            padding: 10px;
            display: inline-block;
            white-space: nowrap;
            animation: marquee 10s linear infinite;
        }

        @keyframes marquee {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        .marqueetext {
            width: 100%;
            overflow: hidden;
            align-items: center;
        }

        .download-button {
            background-color: #008CBA;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-top: 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .download-button:hover {
            background-color: #007B9E;
        }

        .instructions {
            font-size: 14px;
            color: #555;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2>Welcome to Events 3.0</h2>
            <p>Please sign in with Google to access the content.</p>
            <button id="googleSignInButton" class="google-sign-in-button">Sign in with Google</button>
        </div>
    </div>
    <div id="arrow">
        <i class="fas fa-arrow-left nav-arrow left" onclick="prevPage()"></i>
    </div>
    <div class="profile-container">
        <div class="profile-circle" id="profileCircle">
            <img id="profileImage" src="https://via.placeholder.com/50" alt="Profile">
        </div>
        <div class="profile-dropdown" id="profileDropdown" style="display: none;">
            <button class="close-button" id="closeButton">&times;</button>
            <div class="profile-info">
                <h2 id="userName">User Name</h2>
                <p id="userEmail">user@example.com</p>
            </div>
            <div class="purchase-history">
                <h3 style="color: #4285F4;">Purchase History</h3>
                <div class="purchase-list-container">
                    <div id="purchaseList"></div>
                </div>
            </div>
            <div class="account-actions">
                <button id="logoutButton" class="logout-button" style="display: none;">Sign out</button>
                <button id="loginButton" class="login-button">Log in with Gmail</button>
            </div>
        </div>
    </div>
    <div class="container">
        <h1>Event Registration</h1>
        <div id="page1">
            <form id="basicInfoForm">
                <label for="name">Name:</label>
                <input type="text" id="name" required placeholder="Your Name">

                <label for="email">Email:</label>
                <input type="email" id="email" required placeholder="example@gmail.com">

                <label for="phoneno">Phone Number:</label>
                <input type="tel" id="phoneno" placeholder="1234567890" pattern="\d{10}"
                    title="Enter a 10-digit phone number in the format 1234567890 without +91 and without spaces or special characters"
                    required>

                <label>Are you an Amrita student?</label>
                <div>
                    <input type="radio" id="amrita_yes" name="amrita_student" value="yes" required>
                    <label for="amrita_yes">Yes</label>
                </div>
                <div>
                    <input type="radio" id="amrita_no" name="amrita_student" value="no" required>
                    <label for="amrita_no">No</label>
                </div>

                <div id="rollNoField" style="display: none;">
                    <label for="rollNo">Roll Number:</label>
                    <input type="text" id="rollNo" placeholder="Enter your roll number(CH.xx.U4xxxxx)">
                </div>

                <label for="event">Select Event:</label>

                <select id="event" required onchange="updateEventInfo()">
                    <option value="">Choose an event</option>
                    <option value="event12">Forensic Triage Forum</option>
                </select>
                <p id="eventInfo" style="display: none;"></p>

                <label for="teamName">Team Name:</label>
                <input type="text" id="teamName" required>

                <label for="teamSize">Number of Team Members:</label>
                <select id="teamSize" required onchange="updateTeamMembers()">
                    <option value="">Select team size</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>

                <div id="teamMembersContainer"></div>

                <button type="button" onclick="nextPage()">Next</button>
            </form>
        </div>

        <div id="page2" class="hidden">
            <div class="qr-code-section">
                <h2>Payment Information</h2>
                <p>Please make a payment of ₹<span id="paymentAmount">0</span> to complete your registration.</p>
                <br>
                <div class="marqueetext">
                    <p id="highlightedMarquee">For issues in registration, please contact Aravind [ph-no: 7397412269]
                    </p>
                </div>
                <div class="pay">
                    <h1>Scan to Pay</h1>
                    <p class="instructions">
                        <strong>Instructions:</strong> Once you download the QR code, you can open Google Pay or any Upi
                        App, click on
                        the "Scan any QR Code" option, and select "upload or Scan from Gallery" to upload the downloaded
                        QR code.
                        now pay to Proceed.
                    </p>
                    <p style="font-size: 20px; text-align: center;">If one of the options fails, use other options.</p>
                    <br>
                    <div class="qr-options">
                        <button class="qr-option active" onclick="switchQR(1)">Option 1</button>
                        <button class="qr-option" onclick="switchQR(2)">Option 2</button>
                        <button class="qr-option" onclick="switchQR(3)">Option 3</button>
                        <button class="qr-option" onclick="switchQR(4)">Option 4</button>
                    </div>

                    <div class="qr-code-container">
                        <div id="upi-qr1" class="qr-code"></div>
                        <div id="upi-qr2" class="qr-code hidden"></div>
                        <div id="upi-qr3" class="qr-code hidden"></div>
                        <div id="upi-qr4" class="qr-code hidden"></div>
                    </div>
                    <div id="qr-label" class="qr-label">UPI Option 1</div>
                    <br>
                    <button id="download-button" class="download-button">Download QR Code</button>

                    <p class="info">Do not refresh the page. After payment, upload the screenshot.</p>
                    <button type="button" onclick="nextPage(3)">I've made the payment</button>
                </div>
            </div>
        </div>


        <div id="page3" class="hidden">
            <form id="screenshotForm">
                <label for="screenshot">Upload Payment Screenshot:</label>
                <input type="file" id="screenshot" accept="image/*" required>
                <div id="preview"></div>
                <button type="button" onclick="submitForm()">Submit</button>
            </form>
        </div>
    </div>

    <script>
        async function getToken() {
            const response = await fetch('https://backend-server-black.vercel.app/api/get-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data.token;
        }

        async function getFirebaseConfig(token) {
            const response = await fetch('https://backend-server-black.vercel.app/api/firebase-config?configType=config1', {
                headers: {
                    'Authorization': token
                }
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        }

        let db;

        async function initializeApp() {
            try {
                const token = await getToken();
                const config = await getFirebaseConfig(token);
                firebase.initializeApp(config);
                db = firebase.firestore();
                auth = firebase.auth();
                console.log("Firebase and Firestore initialized successfully");
                document.dispatchEvent(new Event('firebaseInitialized'));
            } catch (error) {
                console.error("Error initializing app:", error);
            }
        }

        initializeApp();

        let currentPage = 1;
        const totalPages = 3;
        const teamMembers = [];
        let registrationDocRef = null;
        let currentAmount = 0;

        const events = {
            "event12": { name: "Forensic Triage Forum", price: 100, maxTeamSize: 2 }
        };

        function updateTeamMembers() {
            const container = document.getElementById('teamMembersContainer');
            container.innerHTML = '';
            const teamSize = parseInt(document.getElementById('teamSize').value);
            const grid = document.createElement('div');
            grid.className = 'team-members-grid';
            grid.style.display = 'grid';
            grid.style.gap = '10px';
            grid.style.marginBottom = '20px';

            for (let i = 1; i <= teamSize; i++) {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member-input';
                memberDiv.innerHTML = `
            <label for="teamMember${i}">Team Member ${i} Name:</label>
            <input type="text" id="teamMember${i}" required>
        `;
                grid.appendChild(memberDiv);
            }

            container.appendChild(grid);
            updatePaymentAmount();
        }

        function validateBasicInfo() {
            const form = document.getElementById('basicInfoForm');
            const emailInput = document.getElementById(`email`);
            if (!form.checkValidity()) {
                alert('Please fill out all required fields.');
                return false;
            }

            const teamName = document.getElementById('teamName').value.trim();
            if (!teamName) {
                alert('Please enter a team name.');
                return false;
            }

            const teamSize = parseInt(document.getElementById('teamSize').value);
            if (isNaN(teamSize) || teamSize < 1) {
                alert('Please select a valid team size.');
                return false;
            }

            teamMembers.length = 0;
            for (let i = 1; i <= teamSize; i++) {
                const memberInput = document.getElementById(`teamMember${i}`);

                if (!memberInput) {
                    alert(`Team member input fields are missing. Please select the team size again.`);
                    return false;
                }

                const memberName = memberInput.value.trim();
                if (!memberName) {
                    alert(`Please enter a name for Team Member ${i}`);
                    return false;
                }

                const email = emailInput.value.trim();
                const emailPattern = /^[a-zA-Z0-9._%+-]+@(gmail\.com)$/;
                if (!emailPattern.test(email)) {
                    alert(`Please enter a valid email (only gmail.com are allowed).`);
                    return false;
                }

                teamMembers.push(memberName);
            }
            if (document.getElementById('amrita_yes').checked) {
                const rollNo = document.getElementById('rollNo').value.trim();
                if (!rollNo) {
                    alert('Please enter your roll number.');
                    return false;
                }
            }

            return true;
        }

        function nextPage() {
            if (currentPage < totalPages) {
                if (currentPage === 1 && !validateBasicInfo()) return;
                document.getElementById(`page${currentPage}`).classList.add('hidden');
                currentPage++;
                document.getElementById(`page${currentPage}`).classList.remove('hidden');
                if (currentPage === 2) {
                    updatePaymentAmount();
                }
            }
        }

        function updateEventInfo() {
            const eventSelect = document.getElementById('event');
            const eventInfo = document.getElementById('eventInfo');
            const teamSizeSelect = document.getElementById('teamSize');

            if (eventSelect.value) {
                const selectedEvent = events[eventSelect.value];
                eventInfo.textContent = `Event: ${selectedEvent.name}, Price: ₹${selectedEvent.price}, Max Team Size: ${selectedEvent.maxTeamSize}`;
                eventInfo.style.display = 'block';

                teamSizeSelect.innerHTML = '';
                for (let i = 1; i <= selectedEvent.maxTeamSize; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    teamSizeSelect.appendChild(option);
                }
            } else {
                eventInfo.style.display = 'none';
                teamSizeSelect.innerHTML = '<option value="">Select team size</option>';
            }

            updateTeamMembers();
            updatePaymentAmount();
        }

        function updatePaymentAmount() {
            const eventSelect = document.getElementById('event');
            const teamSizeSelect = document.getElementById('teamSize');
            const paymentAmountSpan = document.getElementById('paymentAmount');

            if (eventSelect.value && teamSizeSelect.value) {
                const eventPrice = events[eventSelect.value].price;
                const totalAmount = eventPrice;
                paymentAmountSpan.textContent = totalAmount;
                currentAmount = totalAmount;
                updateUPIQRCode(totalAmount);
            } else {
                paymentAmountSpan.textContent = '0';
                currentAmount = 0;
                updateUPIQRCode(0);
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                document.getElementById(`page${currentPage}`).classList.add('hidden');
                currentPage--;
                document.getElementById(`page${currentPage}`).classList.remove('hidden');
            }
        }
        function submitForm() {
            const screenshot = document.getElementById('screenshot').files[0];
            const submitButton = document.querySelector('#page3 button');

            if (!screenshot) {
                alert('Please upload a screenshot of your payment.');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';

            // Gather form data
            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phoneno: document.getElementById('phoneno').value,
                event: events[document.getElementById('event').value].name,
                amritaStudent: document.querySelector('input[name="amrita_student"]:checked').value,
                teamName: document.getElementById('teamName').value,
                teamSize: document.getElementById('teamSize').value,
                teamMembers: teamMembers,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };


            if (formData.amritaStudent === 'yes') {
                formData.rollNo = document.getElementById('rollNo').value.trim();
            }

            // Submit to event-specific collection
            db.collection(events[document.getElementById('event').value].name)
                .add(formData)
                .then((eventDocRef) => {
                    console.log("Document written in event-specific collection with ID: ", eventDocRef.id);

                    // Submit to the general "registrations" collection
                    db.collection("registrations").add(formData)
                        .then((regDocRef) => {
                            console.log("Document written in 'registrations' collection with ID: ", regDocRef.id);

                            // Save event doc reference globally for image upload
                            registrationDocRef = eventDocRef;

                            // Proceed with the image upload after both submissions
                            resizeAndUploadImage(screenshot, submitButton);
                        })
                        .catch((error) => {
                            console.error("Error adding document to 'registrations': ", error);
                            alert("Error submitting form to 'registrations'. Please try again.");
                            submitButton.disabled = false;
                            submitButton.textContent = 'Submit';
                        });
                })
                .catch((error) => {
                    console.error("Error adding document to event collection: ", error);
                    alert("Error submitting form to event collection. Please try again.");
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit';
                });
        }

        function resizeAndUploadImage(file, submitButton) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    let width = img.width;
                    let height = img.height;
                    const maxWidth = 800;
                    const maxHeight = 600;

                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;

                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob(function (blob) {
                        uploadToFirebaseStorage(blob, submitButton);
                    }, 'image/jpeg', 0.7);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function uploadToFirebaseStorage(blob, submitButton) {
            if (!registrationDocRef) {
                console.error('Registration document reference is not set');
                return;
            }

            const eventName = events[document.getElementById('event').value].name.replace(/\s+/g, '-');
            const storage = firebase.storage();
            const storageRef = storage.ref();
            const filename = `payment_screenshots/${eventName}/${registrationDocRef.id}.jpg`;
            const fileRef = storageRef.child(filename);

            fileRef.put(blob).then((snapshot) => {
                console.log('Uploaded a blob or file!');
                snapshot.ref.getDownloadURL().then((downloadURL) => {
                    console.log('File available at', downloadURL);
                    registrationDocRef.update({
                        screenshotUrl: downloadURL,
                        registrationComplete: true
                    }).then(() => {
                        generatePDF(downloadURL, registrationDocRef.id).then(() => {
                            submitButton.textContent = '✔ Submitted';
                            setTimeout(() => {
                                window.location.href = '/events/2024/event-2024.html?registration=success';
                            }, 1000);
                        });
                    });
                });
            }).catch((error) => {
                console.error("Error uploading file: ", error);
                alert("Error uploading file. Please try again.");
                submitButton.disabled = false;
                submitButton.textContent = 'Submit';
            });
        }

        function generatePDF(screenshotUrl, registrationId) {
            return new Promise((resolve, reject) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const pageWidth = doc.internal.pageSize.width;
                    const pageHeight = doc.internal.pageSize.height;
                    const margin = 10;

                    doc.setFillColor(255, 255, 255);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setDrawColor(0);
                    doc.setLineWidth(2);
                    doc.rect(margin, margin, pageWidth - 2 * margin, pageHeight - 2 * margin);

                    doc.setTextColor(178, 32, 73);
                    doc.setFontSize(24);
                    doc.setFont(undefined, 'bold');
                    doc.text('ACN', pageWidth / 2, 25, { align: 'center' });

                    doc.setFontSize(16);
                    doc.setFont(undefined, 'normal');
                    doc.text('Event Registration Receipt', pageWidth / 2, 35, { align: 'center' });

                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(12);
                    const paragraphs = [
                        'Thank you for registering for our event. We are excited to have you join us for this amazing experience.',
                        'This receipt serves as confirmation of your registration and payment. Please keep it for your records.',
                        'If you have any questions or need to make changes to your registration, please contact our support team.'
                    ];
                    let yPosition = 50;
                    paragraphs.forEach(paragraph => {
                        doc.text(paragraph, margin + 5, yPosition, { maxWidth: pageWidth - 2 * margin - 10 });
                        yPosition += 20;
                    });

                    yPosition += 10;
                    const detailBoxHeight = 120;
                    doc.setDrawColor(0);
                    doc.setLineWidth(0.5);
                    doc.rect(margin + 5, yPosition, pageWidth - 2 * margin - 10, detailBoxHeight);
                    doc.setTextColor(178, 32, 73);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Event Registration Details', pageWidth / 2, yPosition - 5, { align: 'center' });

                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'normal');
                    const details = [
                        `Registration ID: ${registrationId}`,
                        `Name: ${document.getElementById('name').value}`,
                        `Email: ${document.getElementById('email').value}`,
                        `Phone No: ${document.getElementById('phoneno').value}`,
                        `Event: ${events[document.getElementById('event').value].name}`,
                        `Team Name: ${document.getElementById('teamName').value}`,
                        `Team Size: ${document.getElementById('teamSize').value}`,
                        `Payment Amount: ₹${document.getElementById('paymentAmount').textContent}`
                    ];
                    yPosition += 10;
                    details.forEach(detail => {
                        const lines = doc.splitTextToSize(detail, pageWidth - 2 * margin - 20);
                        doc.text(lines, margin + 10, yPosition);
                        yPosition += lines.length * 10;
                    });
                    yPosition += 10;
                    doc.setTextColor(0, 0, 0);
                    doc.text('Screenshot URL:', margin + 10, yPosition);

                    const linkText = 'Click here to view the payment screenshot';
                    yPosition += 5;
                    doc.setTextColor(0, 0, 255);
                    doc.textWithLink(linkText, margin + 10, yPosition, { url: screenshotUrl });
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    doc.text('Contact: amritacybernation@ch.amrita.edu | Phone: 8110036667 | Website: www.amritacybernation.com', pageWidth / 2, pageHeight - 15, { align: 'center' });
                    doc.save(`event_registration_receipt_for_${events[document.getElementById('event').value].name.replace(/\s+/g, '_')}.pdf`);

                    console.log('Registration complete! Your receipt has been generated and downloaded.');
                    resolve();
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    reject(error);
                }
            });
        }

        let currentSelectedOption = 1;

        function updateUPIQRCode(amount) {
            const upiIds = [
                "saravanan2003cr7@okhdfcbank",
                "aravindmohan1883-1@okhdfcbank",
                "aravindmohan1883@okhdfcbank",
                "saranya.gopu7-1@okhdfcbank"
            ];

            const name = "ACN";
            const transactionNote = "Payment for Event Registration";

            const upiUrls = upiIds.map(upiId =>
                `upi://pay?pa=${upiId}&pn=${name}&am=${amount}&cu=INR&tn=${transactionNote}`
            );

            const qrContainers = [
                document.getElementById("upi-qr1"),
                document.getElementById("upi-qr2"),
                document.getElementById("upi-qr3"),
                document.getElementById("upi-qr4")
            ];

            qrContainers.forEach((qrContainer, index) => {
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: upiUrls[index],
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            });

            switchQR(1); // Initialize with option 1
        }

        function switchQR(option) {
            const qrContainers = [
                document.getElementById("upi-qr1"),
                document.getElementById("upi-qr2"),
                document.getElementById("upi-qr3"),
                document.getElementById("upi-qr4")
            ];
            const label = document.getElementById("qr-label");

            // Hide all QR codes
            qrContainers.forEach(qr => qr.classList.add("hidden"));

            // Show the selected QR code
            qrContainers[option - 1].classList.remove("hidden");
            label.textContent = `UPI Option ${option}`;

            // Update the currently selected option
            currentSelectedOption = option;

            // Update the active state of the buttons
            document.querySelectorAll(".qr-option").forEach((btn, index) => {
                if (index + 1 === option) {
                    btn.classList.add("active");
                } else {
                    btn.classList.remove("active");
                }
            });
        }

        function downloadQR(option) {
            const qrContainers = [
                document.getElementById("upi-qr1"),
                document.getElementById("upi-qr2"),
                document.getElementById("upi-qr3"),
                document.getElementById("upi-qr4")
            ];
            const qrCanvas = qrContainers[option - 1].querySelector('canvas');

            if (qrCanvas) {
                // Create an off-screen canvas to add padding
                const canvas = document.createElement('canvas');
                const padding = 40; // Add 40px padding to each side
                canvas.width = qrCanvas.width + padding * 2;
                canvas.height = qrCanvas.height + padding * 2;
                const ctx = canvas.getContext('2d');

                // Fill the new canvas with a white background (light color for better QR scanning)
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Draw the original QR code in the center of the new canvas
                ctx.drawImage(qrCanvas, padding, padding);

                // Convert to PNG and download
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = `upi-qr-option-${option}.png`;
                link.click();
            } else {
                alert("QR code not available for download.");
            }
        }


        document.getElementById('download-button').addEventListener('click', () => {
            downloadQR(currentSelectedOption);
        });



        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('screenshot').addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const preview = document.getElementById('preview');
                        preview.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; max-height: 200px;">`;
                    }
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('event').addEventListener('change', updateEventInfo);
            document.getElementById('teamSize').addEventListener('change', updateTeamMembers);
        });

        document.addEventListener('DOMContentLoaded', function () {
            const amritaYes = document.getElementById('amrita_yes');
            const amritaNo = document.getElementById('amrita_no');
            const rollNoField = document.getElementById('rollNoField');

            function toggleRollNoField() {
                rollNoField.style.display = amritaYes.checked ? 'block' : 'none';
            }

            amritaYes.addEventListener('change', toggleRollNoField);
            amritaNo.addEventListener('change', toggleRollNoField);


        });


        document.addEventListener('DOMContentLoaded', () => {
            const loginOverlay = document.getElementById('loginOverlay');
            const googleSignInButton = document.getElementById('googleSignInButton');
            const profileCircle = document.getElementById('profileCircle');
            const profileDropdown = document.getElementById('profileDropdown');
            const profileImage = document.getElementById('profileImage');
            const userName = document.getElementById('userName');
            const userEmail = document.getElementById('userEmail');
            const purchaseList = document.getElementById('purchaseList');
            const loginButton = document.getElementById('loginButton');
            const logoutButton = document.getElementById('logoutButton');
            const closeButton = document.getElementById('closeButton');

            function showLoginOverlay() {
                loginOverlay.style.display = 'flex';
            }

            function hideLoginOverlay() {
                loginOverlay.style.display = 'none';
                localStorage.setItem('popupShown', 'true');
            }

            function signInWithGoogle() {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider)
                    .then((result) => {
                        const user = result.user;
                        updateProfileInfo(user);
                        fetchPurchaseHistory(user.email);
                        hideLoginOverlay();
                    })
                    .catch((error) => {
                        console.error('Error during login:', error);
                    });
            }

            googleSignInButton.addEventListener('click', signInWithGoogle);
            loginButton.addEventListener('click', signInWithGoogle);

            profileCircle.addEventListener('click', () => {
                profileDropdown.style.display = profileDropdown.style.display === 'none' ? 'block' : 'none';
            });

            closeButton.addEventListener('click', () => {
                profileDropdown.style.display = 'none';
            });

            logoutButton.addEventListener('click', () => {
                auth.signOut().then(() => {
                    resetProfileInfo();
                    showLoginOverlay();
                    localStorage.removeItem('popupShown');
                }).catch((error) => {
                    console.error('Error logging out:', error);
                });
            });

            document.addEventListener('firebaseInitialized', () => {
                if (auth) {
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            updateProfileInfo(user);
                            fetchPurchaseHistory(user.email);
                            hideLoginOverlay();
                        } else {
                            resetProfileInfo();
                            if (!localStorage.getItem('popupShown')) {
                                showLoginOverlay();
                            }
                        }
                    });
                } else {
                    console.error('Firebase Authentication not initialized properly.');
                }
            });

            function updateProfileInfo(user) {
                profileImage.src = user.photoURL || 'https://via.placeholder.com/50';
                userName.textContent = user.displayName || 'Anonymous User';
                userEmail.textContent = user.email || 'No email available';
                loginButton.style.display = 'none';
                logoutButton.style.display = 'block';
            }

            function resetProfileInfo() {
                profileImage.src = 'https://via.placeholder.com/50';
                userName.textContent = 'User Name';
                userEmail.textContent = 'user@example.com';
                loginButton.style.display = 'block';
                logoutButton.style.display = 'none';
                purchaseList.innerHTML = '';
            }

            function fetchPurchaseHistory(email) {
                if (!db) {
                    console.error('Firestore database not initialized.');
                    return;
                }
                db.collection('registrations')
                    .where('email', '==', email)
                    .get()
                    .then((querySnapshot) => {
                        purchaseList.innerHTML = '';
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            const timestamp = data.timestamp.toDate();
                            const formattedDate = timestamp.toLocaleString();
                            const purchaseItem = document.createElement('div');
                            purchaseItem.classList.add('purchase-item');
                            purchaseItem.textContent = `Event: ${data.event}, Date: ${formattedDate}`;
                            purchaseList.appendChild(purchaseItem);
                        });
                    })
                    .catch((error) => {
                        console.error("Error fetching purchase history: ", error);
                    });
            }

            if (!localStorage.getItem('popupShown')) {
                showLoginOverlay();
            }
        });
    </script>
</body>

</html>